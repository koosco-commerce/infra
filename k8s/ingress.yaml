# 통합 Ingress - 모든 마이크로서비스를 하나의 도메인으로 라우팅
# 사용법: 모든 서비스 배포 후 이 파일을 적용
# kubectl apply -f k8s/ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: commerce-ingress
  namespace: commerce
  labels:
    app: commerce-api
  annotations:
    # Nginx Ingress Controller
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # CORS settings
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "10"

    # Timeout settings
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";
spec:
  ingressClassName: nginx
  rules:
    - host: api.commerce.com # 메인 API 도메인
      http:
        paths:
          # ==========================================
          # Auth Service - 인증/인가
          # ==========================================
          - path: /api/auth(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 80

          # ==========================================
          # User Service - 사용자 관리
          # ==========================================
          - path: /api/users(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 80

          # ==========================================
          # Order Service - 주문 관리
          # ==========================================
          - path: /api/orders(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: order-service
                port:
                  number: 80

          # ==========================================
          # Catalog Service - 상품 관리
          # ==========================================
          - path: /api/catalog(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: catalog-service
                port:
                  number: 80

          # ==========================================
          # Payment Service - 결제 처리
          # ==========================================
          - path: /api/payments(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: payment-service
                port:
                  number: 80

          # ==========================================
          # Notification Service - 알림
          # ==========================================
          - path: /api/notifications(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: notification-service
                port:
                  number: 80

  # TLS 설정 (Let's Encrypt 또는 자체 인증서 사용)
  tls:
    - hosts:
        - api.commerce.com
      secretName: commerce-tls-secret
